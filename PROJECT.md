# üèóÔ∏è Technical Design Document (TDD): "Discord Garden & Home" (MVP)

**Version:** 1.0
**Target:** Discord Embedded App SDK
**Stack:** React + Phaser 3 (Client), Node.js + Colyseus (Server), PostgreSQL (DB).

---

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### 1.1 High-Level Overview

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤–Ω—É—Ç—Ä–∏ iframe Discord.

- **Frontend:** –ì–∏–±—Ä–∏–¥. **React** —É–ø—Ä–∞–≤–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º (HUD, –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å, –ú–∞–≥–∞–∑–∏–Ω), **Phaser 3** —Ä–µ–Ω–¥–µ—Ä–∏—Ç –∏–∑–æ–º–µ—Ç—Ä–∏—á–µ—Å–∫–∏–π –º–∏—Ä (–î–æ–º/–°–∞–¥) –≤ `<canvas>`.
- **Backend:** –ê–≤—Ç–æ—Ä–∏—Ç–∞—Ä–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–∞ **Colyseus** (WebSocket). –í–∞–ª–∏–¥–∏—Ä—É–µ—Ç –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è (–ø–æ–∫—É–ø–∫–∞, —Å–±–æ—Ä —É—Ä–æ–∂–∞—è, –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –º–µ–±–µ–ª–∏).
- **Database:** **PostgreSQL** –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–∏–Ω–≤–µ–Ω—Ç–∞—Ä—å, —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ–º–∞). **Redis** –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å–µ—Å—Å–∏–π –∏ leaderboards.

### 1.2 Discord SDK Integration Points

- **Auth:** `discordSdk.commands.authenticate` ‚Äî –ø–æ–ª—É—á–µ–Ω–∏–µ OAuth2 —Ç–æ–∫–µ–Ω–∞.
- **Voice State:** –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ –∫–∞–Ω–∞–ª–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ "–°–æ—Å–µ–¥–∏".
- **IAP:** `discordSdk.commands.openPremiumSettings` (–∏–ª–∏ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥ SKU) –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–∞.

---

## 2. –ë–∞–∑–∞ –î–∞–Ω–Ω—ã—Ö (Schema Design)

–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è —ç–∫–æ–Ω–æ–º–∏–∫–∏. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–ª—è—Ü–∏–æ–Ω–Ω—É—é –º–æ–¥–µ–ª—å.

### Table: `Users`

| Column       | Type      | Description                        |
| :----------- | :-------- | :--------------------------------- |
| `id`         | UUID      | PK                                 |
| `discord_id` | VARCHAR   | –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∏–∑ Discord           |
| `coins`      | BIGINT    | –ú—è–≥–∫–∞—è –≤–∞–ª—é—Ç–∞                      |
| `gems`       | INT       | –ü—Ä–µ–º–∏—É–º –≤–∞–ª—é—Ç–∞                     |
| `xp`         | BIGINT    | –û–ø—ã—Ç –∏–≥—Ä–æ–∫–∞ (–¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ª–æ–∫–∞—Ü–∏–π) |
| `last_login` | TIMESTAMP | –î–ª—è —Ä–∞—Å—á–µ—Ç–∞ –æ—Ñ–ª–∞–π–Ω-–±–æ–Ω—É—Å–æ–≤         |

### Table: `House_Items` (–†–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã)

_–•—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –º–∏—Ä–∞ –∏–≥—Ä–æ–∫–∞._
| Column | Type | Description |
| :--- | :--- | :--- |
| `id` | UUID | PK |
| `user_id` | UUID | FK -> Users |
| `item_id` | VARCHAR | ID –ø—Ä–µ–¥–º–µ—Ç–∞ (–Ω–∞–ø—Ä. `seed_mint`, `chair_wood`) |
| `grid_x` | INT | –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ X –≤ –∏–∑–æ–º–µ—Ç—Ä–∏–∏ |
| `grid_y` | INT | –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞ Y –≤ –∏–∑–æ–º–µ—Ç—Ä–∏–∏ |
| `state` | JSONB | `{ "stage": 2, "planted_at": 17100000 }` |

### Table: `Pets`

| Column      | Type    | Description                    |
| :---------- | :------ | :----------------------------- |
| `id`        | UUID    | PK                             |
| `user_id`   | UUID    | Owner                          |
| `pet_type`  | VARCHAR | `slime_grass`, `dragon_fire`   |
| `stats`     | JSONB   | `{ "level": 1, "hunger": 80 }` |
| `is_active` | BOOLEAN | –í—ã–±—Ä–∞–Ω –ª–∏ –ø–∏—Ç–æ–º–µ—Ü —Å–µ–π—á–∞—Å       |

---

## 3. –ì–µ–π–º–ø–ª–µ–π–Ω–∞—è –õ–æ–≥–∏–∫–∞ (Server-Side Authority)

–í—Å—è –ª–æ–≥–∏–∫–∞ —Ç–∞–π–º–µ—Ä–æ–≤ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —á–∏—Ç–µ—Ä—Å—Ç–≤–∞ (SpeedHack).

### 3.1 –ú–µ—Ö–∞–Ω–∏–∫–∞ –†–æ—Å—Ç–∞ (The "Overripe" System)

–ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º `setTimeout`. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ Timestamp.

**–ê–ª–≥–æ—Ä–∏—Ç–º –ø—Ä–æ–≤–µ—Ä–∫–∏ —É—Ä–æ–∂–∞—è:**

1.  –ö–ª–∏–µ–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç: `HARVEST_REQUEST { tile_id: 123 }`.
2.  –°–µ—Ä–≤–µ—Ä –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–∞–π–ª–∞ –∏–∑ –ë–î.
3.  –°–µ—Ä–≤–µ—Ä —Å—á–∏—Ç–∞–µ—Ç:

    ```javascript
    const now = Date.now();
    const readyTime = plantedAt + plantConfig.growthTime * modifiers; // –£—á–∏—Ç—ã–≤–∞–µ–º –±–æ–Ω—É—Å—ã –ø–µ—Ç–æ–≤

    if (now >= readyTime) {
      // –£—Å–ø–µ—Ö
      GrantLoot(user, plantConfig.lootTable);
      ResetTile(tile_id);
      return SUCCESS;
    } else {
      return ERROR_NOT_READY;
    }
    ```

4.  **–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è "Overripe":** –ö–ª–∏–µ–Ω—Ç —Å–∞–º –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–∞–π–º—Å—Ç–µ–º–ø—ã –≤ `update()` —Ü–∏–∫–ª–µ Phaser. –ï—Å–ª–∏ `now > readyTime`, —Ä–∏—Å—É–µ—Ç –∏–∫–æ–Ω–∫—É "–°–µ—Ä–ø" –Ω–∞–¥ —Ä–∞—Å—Ç–µ–Ω–∏–µ–º. –†–∞—Å—Ç–µ–Ω–∏–µ –Ω–µ –≤—è–Ω–µ—Ç, –Ω–æ —Å–ª–æ—Ç –∑–∞–Ω—è—Ç, –ø–æ–∫–∞ –∏–≥—Ä–æ–∫ –Ω–µ —Å–æ–±–µ—Ä–µ—Ç.

### 3.2 –°–∏—Å—Ç–µ–º–∞ –Ø–∏—Ü –∏ –ü–∏—Ç–æ–º—Ü–µ–≤

- **–ò–Ω–∫—É–±–∞—Ç–æ—Ä:** –≠—Ç–æ —Ç–æ–∂–µ "–¢–∞–π–ª" —Å –æ—Å–æ–±—ã–º —Å–≤–æ–π—Å—Ç–≤–æ–º.
- **–õ–æ–≥–∏–∫–∞ –≤—ã–ª—É–ø–ª–µ–Ω–∏—è:**
  - `hatch_start`: –í—Ä–µ–º—è –ø–æ–º–µ—â–µ–Ω–∏—è –≤ –≥–Ω–µ–∑–¥–æ.
  - `hatch_duration`: –ë–∞–∑–æ–≤–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä. 2 –º–∏–Ω).
  - **–£—Å–∫–æ—Ä–µ–Ω–∏–µ:** –ï—Å–ª–∏ –∏–≥—Ä–æ–∫ –ø–ª–∞—Ç–∏—Ç Gems, –º—ã –æ–±–Ω–æ–≤–ª—è–µ–º –∑–∞–ø–∏—Å—å –≤ –ë–î: `hatch_start = now - hatch_duration` (–º–≥–Ω–æ–≤–µ–Ω–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ).

### 3.3 Multiplayer & Visiting (Colyseus Rooms)

- **Room Type: `HouseRoom`**
  - –ö–∞–∂–¥—ã–π –∏–≥—Ä–æ–∫ –∏–º–µ–µ—Ç —Å–≤–æ–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `roomId`, –æ—Å–Ω–æ–≤–∞–Ω–Ω—ã–π –Ω–∞ –µ–≥–æ ID.
  - –ö–æ–≥–¥–∞ –≤–ª–∞–¥–µ–ª–µ—Ü –æ–Ω–ª–∞–π–Ω, –∫–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏ —Å–µ—Ä–≤–µ—Ä–∞.
  - **–ì–æ—Å—Ç–∏:** –î—Ä—É–≥–∏–µ –∏–≥—Ä–æ–∫–∏ –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –∫ —ç—Ç–æ–π –∂–µ –∫–æ–º–Ω–∞—Ç–µ —á–µ—Ä–µ–∑ `client.joinById(friendRoomId)`.
  - **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è:** Colyseus State –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—ã–ª–∞–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –∏–≥—Ä–æ–∫–æ–≤ (X, Y) –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–∞–π–ª–æ–≤ –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º.

---

## 4. Frontend Implementation (Client)

### 4.1 –ì—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **Phaser 3:**
  - –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–ª–∞–≥–∏–Ω `phaser-plugin-isometric` –∏–ª–∏ –ø–∏—à–µ–º —Å–≤–æ—é –ø—Ä–æ–µ–∫—Ü–∏—é (Cartesian -> Isometric: `isoX = x - y`, `isoY = (x + y) / 2`).
  - **Assets:** –¢–µ–∫—Å—Ç—É—Ä–Ω—ã–π –∞—Ç–ª–∞—Å (Texture Packer) –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
- **React (Overlay):**
  - –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã: `InventoryModal`, `ShopPanel`, `PetStatus`, `NeighborsList`.
  - –°–≤—è–∑—å —Å Phaser: –ß–µ—Ä–µ–∑ `EventEmitter` (React –Ω–∞–∂–∞–ª "–ö—É–ø–∏—Ç—å" -> —Å–æ–±—ã—Ç–∏–µ –≤ Phaser -> –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä).

### 4.2 Optimistic UI (UX Design)

–ß—Ç–æ–±—ã –∏–≥—Ä–∞ —á—É–≤—Å—Ç–≤–æ–≤–∞–ª–∞—Å—å "–±—ã—Å—Ç—Ä–æ–π" –¥–∞–∂–µ –ø—Ä–∏ –ø–∏–Ω–≥–µ:

1.  –ò–≥—Ä–æ–∫ –Ω–∞–∂–∏–º–∞–µ—Ç "–°–æ–±—Ä–∞—Ç—å –º—è—Ç—É".
2.  Phaser **—Å—Ä–∞–∑—É** –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ—Ç –∑–≤—É–∫ —Å–±–æ—Ä–∞ –∏ –∞–Ω–∏–º–∞—Ü–∏—é –≤—ã–ª–µ—Ç–∞—é—â–∏—Ö –º–æ–Ω–µ—Ç–æ–∫.
3.  –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ —É–ª–µ—Ç–∞–µ—Ç –ø–∞–∫–µ—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
4.  –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É (—á–∏—Ç/–±–∞–≥), —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç–∫–∞—Ç—ã–≤–∞–µ—Ç—Å—è (–º—è—Ç–∞ –ø–æ—è–≤–ª—è–µ—Ç—Å—è —Å–Ω–æ–≤–∞).

---

## 5. –≠–∫–æ–Ω–æ–º–∏–∫–∞ –∏ IAP (Monetization Implementation)

### 5.1 Hardcoded Configs (Anti-Cheat)

–¶–µ–Ω—ã –∏ —Ç–∞–π–º–∏–Ω–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ JSON-–∫–æ–Ω—Ñ–∏–≥–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –∏ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ –¥–ª—è UI. –ö–ª–∏–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –¥–∏–∫—Ç–æ–≤–∞—Ç—å —Ü–µ–Ω—ã.

### 5.2 SKU Setup

–î–ª—è MVP –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º 3 SKU (Stock Keeping Units):

1.  `com.game.pouch_gems_small` (100 Gems) - $0.99
2.  `com.game.pouch_gems_medium` (550 Gems) - $4.99
3.  `com.game.starter_pack` (Pet + Gems) - $2.99

---

## –ü–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ MVP (Sprints)

### –°–ø—Ä–∏–Ω—Ç 1: "The Empty Room" (2 –Ω–µ–¥–µ–ª–∏)

- **Goal:** –ò–≥—Ä–æ–∫ –∑–∞—Ö–æ–¥–∏—Ç, –≤–∏–¥–∏—Ç –∫–æ–º–Ω–∞—Ç—É, —Å—Ç–∞–≤–∏—Ç –º–µ–±–µ–ª—å, –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è.
- **Tasks:**
  - Setup Colyseus + Node.js.
  - Setup Phaser Grid System.
  - Drag & Drop –º–µ–±–µ–ª–∏.
  - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ Postgres.

### –°–ø—Ä–∏–Ω—Ç 2: "The Gardener" (2 –Ω–µ–¥–µ–ª–∏)

- **Goal:** –¶–∏–∫–ª –ø–æ—Å–∞–¥–∫–∏ –∏ —Å–±–æ—Ä–∞ —É—Ä–æ–∂–∞—è.
- **Tasks:**
  - –õ–æ–≥–∏–∫–∞ —Ç–∞–π–º–µ—Ä–æ–≤ —Ä–æ—Å—Ç–∞ (Server-side).
  - –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å —Å–µ–º—è–Ω –∏ —É—Ä–æ–∂–∞—è.
  - –ú–∞–≥–∞–∑–∏–Ω –∑–∞ –º–æ–Ω–µ—Ç—ã (Soft Currency).

### –°–ø—Ä–∏–Ω—Ç 3: "Life & Friends" (2 –Ω–µ–¥–µ–ª–∏)

- **Goal:** –ü–∏—Ç–æ–º—Ü—ã –∏ –í–∏–∑–∏—Ç—ã.
- **Tasks:**
  - –ò–Ω–∫—É–±–∞—Ç–æ—Ä (–ú–µ—Ö–∞–Ω–∏–∫–∞ Gacha).
  - –ü–∞–Ω–µ–ª—å "–°–æ—Å–µ–¥–∏" (—Å–ø–∏—Å–æ–∫ –∏–∑ Discord Voice API).
  - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –∫–æ–º–Ω–∞—Ç–µ –¥—Ä—É–≥–∞.

### –°–ø—Ä–∏–Ω—Ç 4: "Monetization & Polish" (1 –Ω–µ–¥–µ–ª—è)

- **Goal:** –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ —Ä–µ–ª–∏–∑—É.
- **Tasks:**
  - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Discord IAP.
  - –ó–≤—É–∫–∏ –∏ UI –∞–Ω–∏–º–∞—Ü–∏–∏.
  - Load testing (–Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ WebSocket).
